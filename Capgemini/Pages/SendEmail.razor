@page "/email";
@using Domain;
@using CapApplication.Services;
@using Newtonsoft.Json;
@using System.Net.Http.Json;
@inject IToastService ToastService;
@inject IMailService _mailService;
@inject HttpClient _httpClient;


<h3>Send Email</h3>
<p>Please enter your email</p>
<div class="mb-3 mt-4 saleAssetText">
    <label for="Address" class="form-label">Email Address</label>
    <InputText type="text" class="form-control" @bind-Value="Mail.Address" />
</div>
<div class="col-lg-12 ms-3 mt-2">
    <button type="button" class="button SASaveBtn label_font" @onclick="OnSubmitBtnClick">Send</button>
</div>
@if(IsMailSent)
{
    <br/><br/>
    <div class="mb-3 mt-4 saleAssetText">
        <label for="OTP" class="form-label">OTP</label>
        <InputText type="text" class="form-control" @bind-Value="Mail.OTP" />
    </div>
    <div class="col-lg-12 ms-3 mt-2">
        <button type="button" class="button SASaveBtn label_font" @onclick="OnValidateBtnClick">Validate</button>
    </div>
}

@code {
    public Mail Mail { get; set; } = new Mail();
    public bool IsMailSent { get; set; }

    private async Task<string> OnSubmitBtnClick()
    {       
        var response = await _httpClient.GetAsync("WeatherForecast/GetEmail/" + Mail.Address);
        if(response.IsSuccessStatusCode)
        {
            IsMailSent = true;
            ToastService.ShowSuccess("Email containing OTP has been sent successfully. Please check your mailbox for verification.");
            return "STATUS_EMAIL_OK: email containing OTP has been sent successfully.";
        }
        return "";
    }

    private async Task OnValidateBtnClick()
    {
        
    }
    // private void ValidateEmailAddress()
    // {
    //     string trimmedAddress = Mail.Address.Substring(Mail.Address.LastIndexOf("@") + 1);
    //     if(!trimmedAddress.Contains(".dso.org.sg"))
    //     {
    //         ToastService.ShowError("Email address must end with .dso.org.sg");
    //     }
    // }

}
